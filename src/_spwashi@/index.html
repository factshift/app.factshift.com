<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>spwashi@</title>
    <script type="module">
      import "../css/style.css";
      import "../css/dataindex.css";
      import "../css/_spwashi@.scss";
      import {app}                   from '../js'
      import {processSpwInput}       from "../js/modes/spw/process-spw-input";
      import {mapNodes, pushNode}    from "../js/simulation/nodes/data/operate";
      import {boonConcept, boonNode} from "../js/modes/spw/commands/boon";
      import {filterNodes}           from "../js/simulation/nodes/data/set";
      import {pushLink}              from "../js/simulation/edges/data/pushLink";

      app()

      let i = 0;

      let prev;

      function getLoopRunner(dayLen, nodeCount, dayName, charge, speed) {
        const run = (res = () => {}) => {
          const heightMod = dayLen;
          if ((i % dayLen) === 0) {
            prev = undefined;
          }
          const curr = {
            id:              i,
            r:               20,
            identity:        dayName.split('')[i % dayLen],
            collisionRadius: 100,
            text:            {
              fontSize: 50,
              fy:       50,
              color:    'white'
            },
            fx:              (((i % dayLen) / dayLen) * window.spwashi.parameters.width) + ((1 / (2 * dayLen)) * window.spwashi.parameters.width),
            fy:              window.spwashi.parameters.height * ((i % heightMod) / heightMod),
            y:     window.spwashi.parameters.height * ((i % heightMod) / heightMod),
            color: 'var(--bg-start)'
          };
          pushNode(curr);
          prev && pushLink(window.spwashi.links, {
            source:   curr,
            target:   prev,
            strength: .3
          });
          prev = curr;
          window.spwashi.reinit();
          processSpwInput(
            [
              // `add=1`,
              // `r=${50}`,
              // `color=${(i % 2) + 1}`,
              // 'arrange',
              `charge=${charge}`
            ].filter(Boolean)
             .join('\n')
          );

          res();
          mainLoop(speed, {charge: -charge});
          i += 1;
        };
        return run;
      }

      function mainLoop(speed = 1000, {charge = 1000}) {
        const locale    = 'en-US';
        const dayName   = (new Date()).toLocaleDateString(locale, {weekday: 'long'}).toLowerCase();
        const dayLen    = dayName.length;
        const nodeCount = 7;
        const run       = getLoopRunner(dayLen, nodeCount, dayName, charge, speed);

        return (new Promise((res, rej) => {
          setTimeout(() => run(res), speed);
        })).then(() => {
          if (i % nodeCount === 0) {
            setTimeout(() => {
              filterNodes((node) => node.kind !== '__boon');
              mapNodes((node) => {
                node.fy = undefined;
              });
              processSpwInput('bonk')
            }, (speed * nodeCount * 2 / 3));
          }
          if (i % nodeCount === 0) {
            // runClearCommand()
            window.spwashi.boon(speed / 2, nodeCount).then(nodes => {
              nodes.forEach(node => { node.fy += 50; });
              window.spwashi.reinit();
            });
          }
        })
      }

      boonConcept['@node'] = (index, batchSize) => {
        const currentDayIndex = (new Date()).getDay();
        return {
          ...boonNode(index, batchSize),
          text:      {
            fontSize: 50,
            fy:       50,
            color:    'rgba(255, 255, 255, .2)'
          },
          color:     index === currentDayIndex ? 'turquoise' : 'rgba(255, 255, 255, .1)',
          callbacks: {
            ondrag: (e, node) => {
              const width  = window.spwashi.parameters.width;
              const height = window.spwashi.parameters.height;
              const r      = 255 * (node.x / width);
              const y      = 255 * (node.y / height);
              const b      = 255 * (node.x / width);

              node.color = `rgb(${r}, ${y}, ${b})`;
            }
          }
          // r: 10
        };
      }

      setTimeout(() => {
        processSpwInput(
          [
            // 'minimalism',
            'box=0'
            // 'velocityDecay=.4',
          ].join('\n')
        );
        mainLoop(300, {charge: 1000});
      }, 1000);
    </script>
    <style lang="sass">

    </style>
    <style>
        :root {
            --bg-start: #008080;
            --bg-end: #67bdb0;
        }

        @keyframes html-background {
            from { background-color: var(--bg-start); }
            to { background-color: var(--bg-end); }
        }

        html {
            animation-name: html-background;
            animation-duration: 2s;
            animation-fill-mode: forwards;
        }

        body {
            animation-name: html-background;
            animation-duration: 2s;
            animation-fill-mode: forwards;
            --bg-end: #008080;
            --bg-start: rgba(239, 239, 239, .3);
        }
    </style>
</head>
<body>
    <h1>_spwashi@</h1>
    <a id="title-md5" tabindex="-1"></a>
    <svg id="simulation">
        <g class="simulation-content">
            <g class="rects"></g>
            <g class="edges"></g>
            <g class="nodes"></g>
        </g>
    </svg>
    <button class="enable-sounds">enable sounds</button>
    <button class="disable-sounds">disable sounds</button>
</body>
</html>