<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>spwashi@</title>
    <script type="module">
      import {app}                   from '../js'
      import {processSpwInput}       from "../js/modes/spw/process-spw-input";
      import {runClearCommand}       from "../js/modes/spw/commands/clear";
      import {mapNodes, pushNode}    from "../js/simulation/nodes/data/operate";
      import {boonConcept, boonNode} from "../js/modes/spw/commands/boon";
      import {filterNodes}           from "../js/simulation/nodes/data/set";

      app()

      let i = 0;

      function mainLoop(speed = 1000, {charge = 1000}) {
        i += 1;
        const nodeCount = 3;
        const run       = (res = () => {}) => {
          pushNode({
                     id:    i,
                     r:     10,
                     x:     (i % nodeCount) * (window.spwashi.parameters.width / nodeCount),
                     fy:    window.spwashi.parameters.height * .75,
                     color: 'var(--bg-start)'
                   })
          // window.spwashi.reinit();
          processSpwInput(
            [
              // `add=1`,
              // `r=${50}`,
              // `color=${(i % 2) + 1}`,
              'arrange',
              `charge=${charge}`
            ].filter(Boolean)
             .join('\n')
          );

          res();
          mainLoop(speed, {charge: -charge});
        };
        return (new Promise((res, rej) => {
          setTimeout(() => run(res), speed);
        })).then(() => {
          if (i % nodeCount === 0) {
            setTimeout(() => {
              filterNodes((node) => node.kind !== '__boon');
              mapNodes((node) => {
                node.fy = undefined;
              });
              processSpwInput('scatter\nbonk')
            }, (speed * nodeCount * 2 / 3));
          }
          if (i % nodeCount === 0) {
            // runClearCommand()
            window.spwashi.boon(speed / 2, nodeCount);
          }
        })
      }

      boonConcept['@node'] = (index, batchSize) => {
        return {
          ...boonNode(index, batchSize),
          callbacks: {
            ondrag: (e, node) => {
              const width  = window.spwashi.parameters.width;
              const height = window.spwashi.parameters.height;
              const r      = 255 * (node.x / width);
              const y      = 255 * (node.y / height);
              const b      = 255 * (node.x / width);

              node.color = `rgb(${r}, ${y}, ${b})`;
            }
          }
          // r: 10
        };
      }

      setTimeout(() => {
        processSpwInput(
          [
            'minimalism',
            // 'velocityDecay=.4',
          ].join('\n')
        );
        mainLoop(1000, {charge: 1000});
      }, 1000);
    </script>
    <link href="../css/style.css" rel="stylesheet"/>
    <link href="../css/dataindex.css" rel="stylesheet"/>
    <style>
        :root {
            --bg-start: #008080;
            --bg-end: #67bdb0;
        }

        @keyframes html-background {
            from { background-color: var(--bg-start); }
            to { background-color: var(--bg-end); }
        }

        html {
            animation-name: html-background;
            animation-duration: 2s;
            animation-fill-mode: forwards;
        }

        body {
            animation-name: html-background;
            animation-duration: 2s;
            animation-fill-mode: forwards;
            --bg-end: #008080;
            --bg-start: rgba(239, 239, 239, .3);
        }
    </style>
</head>
<body>
    <h1>_spwashi@</h1>
    <a id="title-md5" tabindex="-1"></a>
    <svg id="simulation">
        <g class="simulation-content">
            <g class="rects"></g>
            <g class="edges"></g>
            <g class="nodes"></g>
        </g>
    </svg>
</body>
</html>