<!DOCTYPE html>
<head>
    <title>D3 page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-md5@0.8.3/src/md5.min.js"></script>

    <script defer src="js/parameters.js" type="application/javascript"></script>
    <script defer src="js/nodes/colors.js" type="application/javascript"></script>
    <script defer src="js/nodes/images.js" type="application/javascript"></script>
    <script defer src="js/nodes/store.js" type="application/javascript"></script>
    <script defer src="js/nodes/circle.js" type="application/javascript"></script>
    <script defer src="js/nodes/rect.js" type="application/javascript"></script>
    <script defer src="js/nodes/image.js" type="application/javascript"></script>
    <script defer src="js/nodes/text.js" type="application/javascript"></script>
    <script defer src="js/nodes/nodes.js" type="application/javascript"></script>
    <script defer src="js/links.js" type="application/javascript"></script>
    <script defer src="js/rects/rects.js" type="application/javascript"></script>
    <script defer src="js/interactions.js" type="application/javascript"></script>
    <script defer src="js/controls.js" type="application/javascript"></script>
    <script defer src="js/simulation.js" type="application/javascript"></script>
    <script defer src="js/input.js" type="application/javascript"></script>

    <script type="module">
      import {parse}           from "./vendor/spw/parser/parse.mjs";
      import {CharacterCursor} from "./vendor/spw/core/node/cursor.mjs";

      window.spwashi       = window.spwashi || {};
      window.spwashi.parse = (text) => {
        const tokens    = [];
        const generator = parse(text, {asGenerator: true});
        for (let value of generator) {
          if (CharacterCursor.isCharacterCursor(value)) {
            tokens.push(value.getToken());
          }
        }
        return tokens;
      };
    </script>
    <link href="css/style.css" rel="stylesheet"/>
    <link href="css/dataindex.css" rel="stylesheet"/>
</head>
<body data-mode="nothing">
    <section id="colors">
        <button data-dataindex="spwashi-datum-0" class="color cls-0"></button>
        <button data-dataindex="spwashi-datum-1" class="color cls-1"></button>
        <button data-dataindex="spwashi-datum-2" class="color cls-2"></button>
        <button data-dataindex="spwashi-datum-3" class="color cls-3"></button>
        <button data-dataindex="spwashi-datum-4" class="color cls-4"></button>
        <button data-dataindex="spwashi-datum-5" class="color cls-5"></button>
        <button data-dataindex="spwashi-datum-6" class="color cls-6"></button>
        <button data-dataindex="spwashi-datum-7" class="color cls-7"></button>
        <button data-dataindex="spwashi-datum-8" class="color cls-8"></button>
        <button data-dataindex="spwashi-datum-9" class="color cls-9"></button>
        <button data-dataindex="spwashi-datum-10" class="color cls-10"></button>
        <button data-dataindex="spwashi-datum-11" class="color cls-11"></button>
        <button data-dataindex="spwashi-datum-12" class="color cls-12"></button>
    </section>
    <section id="main-button-container">
        <script type="application/javascript">
          window.spwashi      = window.spwashi || {};
          window.spwashi.boon = () => {
            window.spwashi.nodes.push(...[
              {
                name:       'boon',
                colorindex: getColorIndex(),
              },
              {
                name:       'boon',
                colorindex: getColorIndex(),
              },
              {
                name:       'boon',
                colorindex: getColorIndex(),
              }
            ]);
            window.spwashi.reinit();
          };
          window.spwashi.bone = () => {
            window.spwashi.links = window.spwashi.links || [];

            const nodeBuckets = new Map();
            for (let node of window.spwashi.nodes) {
              const bucket = nodeBuckets.get(node.colorindex) || [];
              bucket.push(node);
              nodeBuckets.set(node.colorindex, bucket);
            }


            [...nodeBuckets.values()].forEach(arr => {
              let prev;
              let first;
              for (let node of arr) {
                first = first || node;
                let source = window.spwashi.getNode ? (prev?.id) : '';
                let target = window.spwashi.getNode ? (node.id) : '';
                const link = {
                  source:   source,
                  target:   target,
                  strength: window.spwashi.parameters.links.strength * .3
                };
                source && pushLink(window.spwashi.links, link);
                prev = node;
              }
              pushLink(window.spwashi.links, {
                source:   prev?.id,
                target:   first?.id,
                strength: window.spwashi.parameters.links.strength * .3
              })
            });


            window.spwashi.reinit();
          };
          window.spwashi.bonk = () => {
            window.spwashi.nodes.forEach(n => n.colorindex += 1)
            window.spwashi.reinit();
          };
          window.spwashi.honk = () => {
            window.spwashi.links.forEach(link => link.strength = 1)
            window.spwashi.reinit();
          }
        </script>
        <button
                data-dataindex="spwashi-datum-0"
                class="color cls-0"
                onclick="window.spwashi.boon()"
        >
            boon
        </button>
        <button
                data-dataindex="spwashi-datum-1"
                class="color cls-1"
                onclick="let arr=window.spwashi.nodes.filter(d=>d.id.indexOf('node:')<0);window.spwashi.nodes.length=0;window.spwashi.nodes.push(...arr);console.log(arr);window.spwashi.reinit()"
        >
            bane
        </button>
        <button
                data-dataindex="spwashi-datum-2"
                class="color cls-2"
                onclick="window.spwashi.bone()"
        >
            bone
        </button>
        <button
                data-dataindex="spwashi-datum-3"
                class="color cls-3"
                onclick="window.spwashi.bonk()"
        >
            bonk
        </button>
        <button
                data-dataindex="spwashi-datum-4"
                class="color cls-4"
                onclick="window.spwashi.honk()"
        >
            honk
        </button>
        <button
                data-dataindex="spwashi-datum-6"
                class="color cls-6"
                onclick="window.spwashi.parameters.forces.charge = 100;window.spwashi.reinit();"
        >
            [charge = 100]
        </button>
        <button
                data-dataindex="spwashi-datum-5"
                class="color cls-5"
                onclick="window.spwashi.parameters.forces.charge = 0;window.spwashi.reinit();"
        >
            [charge = 0]
        </button>
        <button
                data-dataindex="spwashi-datum-7"
                class="color cls-7"
                onclick="window.spwashi.parameters.forces.charge = -100;window.spwashi.reinit();"
        >
            [charge = -100]
        </button>
        <button
                data-dataindex="spwashi-datum-8"
                class="color cls-8"
                onclick="window.spwashi.parameters.forces.charge += 10;window.spwashi.reinit();"
        >
            [charge +10]
        </button>
        <button
                data-dataindex="spwashi-datum-9"
                class="color cls-9"
                onclick="window.spwashi.parameters.forces.charge -= 10;window.spwashi.reinit();"
        >
            [charge -10]
        </button>
        <button
                data-dataindex="spwashi-datum-10"
                class="color cls-10"
        >
            [#]
        </button>
        <button
                data-dataindex="spwashi-datum-11"
                class="color cls-11"
        >
            [#]
        </button>
        <button
                data-dataindex="spwashi-datum-12"
                class="color cls-12"
        >
            [#]
        </button>
    </section>
    <section id="main-log">
        <ul class="events-log"></ul>
    </section>
    <main>
        <aside id="spw-mode-container">
            <div id="spw-container">
                <label>
                    <span>SPW</span>
                </label>
                <div id="spw-parse-field"></div>
                <button id="parse-spw">parse</button>
            </div>
        </aside>
        <aside id="direct-mode-container">
            <form id="map-filter-form">
                <div class="editor-wrapper">
                    <label for="node-mapper-enabler">
                        <span>Node Map Function</span>
                    </label>
                    <div class="input-wrapper">
                        <input class="checked-enabler" id="node-mapper-enabler" type="checkbox"/>
                        <div id="node-mapper" class="code-editor"></div>
                    </div>
                </div>
                <div class="editor-wrapper">
                    <label for="node-filter-enabler">
                        <span>Node Filter Function</span>
                    </label>
                    <div class="input-wrapper">
                        <input class="checked-enabler" id="node-filter-enabler" type="checkbox"/>
                        <div id="node-filter" class="code-editor"></div>
                    </div>
                </div>
                <button type="submit">submit</button>
            </form>
            <script src="/vendor/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
        </aside>
        <aside id="querymod-mode-container">
            <div id="query-parameters">
                <textarea class="value"></textarea>
                <button class="go">go</button>
            </div>
            <form id="change-parameters-form">
                <label><span>version</span><input name="version" value="boon"/></label>
                <label>
                    <span>superpower</span>
                    <select name="superpower" value="grow">
                        <option>shrink</option>
                        <option>changecolor</option>
                        <option>grow</option>
                    </select>
                </label>
                <label><span>weight</span><input name="weight" value="100"/></label>
                <label><span>node count</span><input name="nodeCount" value="13" type="number"/></label>
                <label><span>link strength</span><input name="linkstrength" value=".5" type="number" step=".1"/></label>
                <button type="submit">Submit</button>
            </form>
        </aside>
        <aside id="node-mode-container">
            <div id="node-input-container">
                <label><span>Nodes Input</span><textarea id="nodes-input"></textarea></label>
                <label><span>Data Selector</span><textarea id="nodes-selector-fn"></textarea></label>
                <button class="replace">replace</button>
                <button class="add">add</button>
            </div>
            <div id="controls">
                <label>
                    <span>Data Buttons</span>
                    <div class="button-container">
                        <button class="save-nodes">save</button>
                        <button class="generate-nodes">generate</button>
                        <button class="clear-saved-nodes">clear</button>
                        <button class="read-nodes">read</button>
                        <button class="clear-fixed-positions">free</button>
                    </div>
                </label>
                <label>
                    <span>Simulation Buttons</span>
                    <div class="button-container">
                        <button class="stop">stop</button>
                        <button class="tick">tick</button>
                        <button class="start">start</button>
                        <button class="reinit">reinit</button>
                    </div>
                </label>
            </div>
        </aside>
        <div id="content">
            <svg id="simulation">
                <g class="links"></g>
                <g class="nodes"></g>
                <g class="rects"></g>
            </svg>
        </div>
    </main>
    <output id="output" style="position:absolute;top:0;left:0;white-space:pre;color:wheat;"></output>
    <label id="show-keystroke-options">
        <span>Hotkeys</span>
        <input type="checkbox"/>
    </label>
    <aside id="keystroke-options"></aside>
    <aside id="mode-selection-container">
        <label>
            <span>Mode</span>
            <select name="mode" id="mode-selector">
                <option></option>
                <option>spw</option>
                <option>node</option>
                <option>map</option>
                <option>filter</option>
                <option>query</option>
            </select>
        </label>
    </aside>
</body>
